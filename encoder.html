<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js" integrity="sha256-/H4YS+7aYb9kJ5OKhFYPUjSJdrtV6AeyJOtTkw6X72o=" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    </head>
    <body>
        <div id="inputs">
            <input id="inputFile" type="file" required />
            <br/>
            <input id="pass" type="text" placeholder="رمز مورد استفاده " required />
            <br/>
            <button onclick="encodeImage()">رمزنگاری کن</button>
        </div>


        <div id="result-div" style="display: none;">
            <span>
                Base64: 
            </span>
            <div id="base64-text" style="border: 1px solid; width: 300px; white-space: nowrap; overflow: scroll; text-overflow: clip;" >
                <!-- will contain the base64 text-->
            </div>

            <!-- allows the user to download the generated file -->
            <button onclick="download_encrypted()">Download Encrypted</button>
        </div>


        <script type='text/javascript'>

            // encrypt the given text using the provided password
            function encrypt_text(dec_text, pass) {
                return CryptoJS.AES.encrypt(dec_text, pass);
            }

            // dycript using the provided password
            function decrypt_text(enc_text, pass) {
                return CryptoJS.AES.decrypt(enc_text, pass).toString(CryptoJS.enc.Utf8);
            }

            function encodeImage() {
                if ($("#inputFile").val() == '' || $("#pass").val() == '') {
                    alert("لطفا همه ی فیلد ها را پر کنید");
                    return;
                }     
                
                var pass = $("#pass").val()                
                var filesSelected = document.getElementById("inputFile").files;
                if (filesSelected.length > 0) {
                    var fileToLoad = filesSelected[0];
                    var fileReader = new FileReader();
                    fileReader.onload = function(fileLoadedEvent) {
                        // show the result div
                        $("#result-div").show();
                        $("#inputs").hide();

                        // create base64
                        var srcData = fileLoadedEvent.target.result;
                        $("#base64-text").html(srcData);
                        console.log("Converted Base64 version is " + $("#base64-text").html());

                        // encrypt it 
                        enc_text = encrypt_text(srcData, pass);

                        // draw picture back from the encrypted version
                        decrypted_content = show_decryptted_image_from_encrypted_text(enc_text, pass)
                    }
                    fileReader.readAsDataURL(fileToLoad);
                }
            }

            function show_decryptted_image_from_encrypted_text(encrypted_text, pass){
                content = decrypt_text(encrypted_text, pass)
                var image = new Image();
                image.src = content;
                document.body.appendChild(image);
            }

            function download_encrypted() {
                var pass = $("#pass").val();

                // output filename
                filename = $("#inputFile").prop('files')[0].name + ".txt";

                // first convert image to base64
                content = $("#base64-text").html();

                // then encrypt
                enc_content = encrypt_text(content, pass);

                var element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(enc_content));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            }
        </script>

    </body>
</html>